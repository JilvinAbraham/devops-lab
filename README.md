# devops-lab

This project automates the deployment of a lightweight Kubernetes cluster using **K3s**. It leverages **Terraform** for provisioning virtual machines (using Multipass) and **Ansible** for configuring the K3s cluster on the provisioned VMs. The project is structured into three main components:

---

### Components

1. **Terraform**:
   - Used to provision virtual machines (VMs) for the Kubernetes cluster using **Multipass**.
   - Creates:
     - A master node (`k3s-master`) with 4 CPUs and 4GB of memory.
     - A worker node (`k3s-worker`) with 2 CPUs and 1GB of memory.
   - Automatically fetches the IP addresses of the VMs and appends them to the Ansible inventory file (`hosts.ini`).

2. **Ansible**:
   - Configures the Kubernetes cluster on the provisioned VMs.
   - Roles:
     - **`k3s-master`**: Installs K3s on the master node, configures the cluster, and sets up the kubeconfig file.
     - **`k3s-worker`**: Installs K3s on the worker node and joins it to the cluster.
   - Tasks include:
     - Installing K3s.
     - Configuring the `k3s.service` file with custom options.
     - Fetching the kubeconfig file from the master node and modifying it for local use.

3. **Ansible Inventory**:
   - Dynamically updated by Terraform to include the IP addresses of the master and worker nodes.

---

### Project Structure

```plaintext
devops-lab/
├── ansible/
│   ├── inventory/
│   │   ├── hosts.ini                # Ansible inventory file (updated by Terraform)
│   │   └── group_vars/
│   │       └── all.yml              # Global variables for Ansible
│   ├── roles/
│   │   ├── k3s-master/
│   │   │   ├── tasks/
│   │   │   │   └── main.yml         # Tasks for configuring the master node
│   │   │   └── handlers/
│   │   │       └── main.yml         # Handlers for reloading/restarting services
│   │   ├── k3s-worker/
│   │   │   └── tasks/
│   │   │       └── main.yml         # Tasks for configuring the worker node
│   ├── setup_k3s.yml                # Main Ansible playbook
├── terraform/
│   ├── main.tf                      # Terraform configuration for provisioning VMs
│   ├── cloud-init.yaml              # Cloud-init configuration for VMs
├── .gitignore                       # Git ignore file
├── LICENSE                          # License file
├── README.md                        # Project documentation
```

---

### Workflow

1. **Provision VMs with Terraform**:
   - Run `terraform apply` to create the master and worker VMs using Multipass.
   - Terraform appends the IP addresses of the VMs to the Ansible inventory file (`hosts.ini`).

2. **Configure the K3s Cluster with Ansible**:
   - Run the Ansible playbook (`setup_k3s.yml`) to:
     - Install and configure K3s on the master node.
     - Install and configure K3s on the worker node and join it to the cluster.
     - Fetch the kubeconfig file from the master node and modify it for local use.

3. **Access the Kubernetes Cluster**:
   - Use the modified kubeconfig file (`k3s.yaml`) to interact with the Kubernetes cluster from your local machine.

---

### Commands

#### Terraform
- Initialize Terraform:
  ```bash
  terraform init
  ```
- Apply the Terraform configuration:
  ```bash
  terraform apply
  ```
- Destroy the VMs:
  ```bash
  terraform destroy
  ```

#### Ansible
- Run the Ansible playbook:
  ```bash
  ansible-playbook -i ansible/inventory/hosts.ini ansible/setup_k3s.yml
  ```

---

### Features

1. **Dynamic Inventory**:
   - Terraform dynamically updates the Ansible inventory file with the IP addresses of the VMs.

2. **Lightweight Kubernetes**:
   - Uses K3s, a lightweight Kubernetes distribution, for quick and efficient cluster setup.

3. **Automation**:
   - Fully automated provisioning and configuration using Terraform and Ansible.

4. **Custom Configuration**:
   - Allows customization of the `k3s.service` file with options like `--advertise-address` and `--tls-san`.

---

### Prerequisites

1. **Terraform**:
   - Install Terraform: [https://www.terraform.io/downloads.html](https://www.terraform.io/downloads.html)

2. **Multipass**:
   - Install Multipass: [https://multipass.run/](https://multipass.run/)

3. **Ansible**:
   - Install Ansible: [https://docs.ansible.com/ansible/latest/installation_guide/index.html](https://docs.ansible.com/ansible/latest/installation_guide/index.html)

4. **SSH Key**:
   - Ensure your SSH key is configured in all.yml.

---

### Example hosts.ini (Generated by Terraform)

```ini
[k3s_master]
192.168.0.100

[k3s_worker]
192.168.0.101
```

---

### Example `k3s.yaml` (Modified by Ansible)

```yaml
apiVersion: v1
clusters:
- cluster:
    server: https://192.168.0.100:6443
    certificate-authority-data: <CERTIFICATE>
  name: default
contexts:
- context:
    cluster: default
    user: default
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: default
  user:
    token: <TOKEN>
```

